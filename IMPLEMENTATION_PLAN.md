# 实施计划：搜索引擎智能路由优化

## 目标
将搜索引擎实现统一到智能路由架构，通过 `EngineRouter` 实现引擎管理、健康检查、负载均衡和故障转移。

## 推荐方案

**选择方案二（智能路由实现）**：`SmartSearchEngine` + `EngineRouter`

**理由**：
- 架构先进：分层设计，职责清晰
- 代码复用：共享路由、健康检查、负载均衡逻辑
- 可靠性高：自动故障转移和健康恢复机制
- 可扩展性：新增引擎只需实现 trait 并注册

## 分阶段迁移策略

### 阶段一：功能完善（当前阶段）
- [ ] 完善 SmartSearchEngine 功能覆盖
- [ ] 添加速率限制、超时控制、测试数据加载
- [ ] 完善搜索引擎工厂方法
- [ ] 创建示例代码

### 阶段二：功能验证
- [ ] 运行单元测试验证功能
- [ ] 添加集成测试验证路由和故障转移
- [ ] 对比性能指标

### 阶段三：渐进式切换
- [ ] 添加功能开关控制引擎选择
- [ ] 监控新架构运行稳定性
- [ ] 收集性能数据

### 阶段四：代码精简
- [ ] 评估废弃原始实现
- [ ] 移除重复代码
- [ ] 更新文档

## 架构对比

### 原始实现（当前）
```
SearchEngine Trait
├── GoogleSearchEngine (独立 HTTP 客户端)
├── BingSearchEngine (独立 HTTP 客户端)
└── BaiduSearchEngine (独立 HTTP 客户端)
```

### 智能路由实现（目标）
```
SmartSearchEngine (封装 EngineRouter)
└── EngineRouter
    ├── 搜索引擎注册表
    ├── 健康状态管理
    ├── 负载均衡策略
    └── 故障转移机制
```

## 实施任务

### 任务 1: 完善 SmartSearchEngine 功能
- [ ] 添加速率限制支持（参考 bing.rs 的 rate_limit）
- [ ] 添加测试数据加载逻辑
- [ ] 添加超时控制
- [ ] 完善错误处理

### 任务 2: 完善搜索引擎工厂
- [ ] 添加 `create_engine_router()` 工厂方法
- [ ] 添加引擎注册辅助函数
- [ ] 导出统一的创建接口

### 任务 3: 创建示例代码
- [ ] 创建 `smart_search_demo.rs`
- [ ] 展示基本搜索用法
- [ ] 展示健康监控用法
- [ ] 展示故障转移行为

### 任务 4: 验证测试
- [ ] 运行现有测试确保无回归
- [ ] 添加新功能的单元测试
- [ ] 添加集成测试

## 关键文件

| 文件 | 作用 |
|-----|-----|
| `src/infrastructure/search/smart_search.rs` | 智能搜索引擎主实现 |
| `src/infrastructure/search/search_engine_router.rs` | 搜索引擎路由器 |
| `src/infrastructure/search/factory.rs` | 搜索引擎工厂 |
| `src/infrastructure/search/mod.rs` | 模块导出 |

## 验收标准

1. SmartSearchEngine 功能完整（速率限制、测试数据、超时控制）
2. 所有现有测试通过
3. 示例代码可正常运行
4. 文档更新完成

## 风险与缓解

| 风险 | 缓解措施 |
|-----|---------|
| 功能覆盖不全 | 对比原始实现补充功能 |
| 性能下降 | 性能测试对比验证 |
| 测试数据失效 | 复用现有测试配置 |

## 更新日志

| 日期 | 更新内容 |
|-----|---------|
| 2025-12-24 | 制定分阶段迁移策略，选择智能路由方案 |
