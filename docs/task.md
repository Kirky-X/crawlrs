# crawlrs - 任务开发文档 (TASK)

## 版本信息
- **文档版本**: v2.0.0
- **项目周期**: 12 周（3 个月）
- **最近更新**: 2024-12-10

---

## 1. 项目路线图

### 1.1 总体规划

```
Phase 1 (Week 1-3)  →  Phase 2 (Week 4-7)  →  Phase 3 (Week 8-10)  →  Phase 4 (Week 11-12)
基础架构搭建          核心功能开发           高级特性与优化          测试与上线准备
```

### 1.2 里程碑

| 里程碑 | 时间 | 目标 | 交付物 |
|--------|------|------|--------|
| **M1: MVP** | Week 3 | 基础抓取能力 | 单机可运行的原型 |
| **M2: Alpha** | Week 7 | 完整核心功能 | 可用的 API 服务 |
| **M3: Beta** | Week 10 | 生产级特性 | 集群部署方案 |
| **M4: GA** | Week 12 | 正式发布 | 完整文档 + 监控 |

---

## 2. Phase 1: 基础架构搭建（Week 1-3）

### 2.1 Week 1: 项目初始化与数据层

#### 任务清单

**TASK-001: 项目脚手架**
- **优先级**: P0（最高）
- **工时**: 2 天
- **负责人**: 架构师
- **描述**: 初始化 Cargo 项目，配置 CI/CD，搭建目录结构
- **交付物**:
  ```
  ✓ Cargo.toml 配置完成
  ✓ 目录结构符合 DDD 分层
  ✓ GitHub Actions 配置
  ✓ pre-commit hooks 配置
  ```
- **验收标准**:
  - [ ] `cargo build` 成功
  - [ ] `cargo clippy` 无警告
  - [ ] `cargo fmt -- --check` 通过

**TASK-002: 数据库设计与迁移**
- **优先级**: P0
- **工时**: 3 天
- **负责人**: 后端工程师
- **描述**: 设计核心表结构，配置 SeaORM，编写迁移脚本
- **依赖**: TASK-001
- **交付物**:
  ```
  ✓ migrations/ 目录包含所有迁移文件
  ✓ src/infrastructure/database/entities/ 生成的实体
  ✓ 数据库连接池配置
  ```
- **验收标准**:
  - [ ] 迁移脚本可正常执行
  - [ ] 所有表索引创建成功
  - [ ] 连接池压力测试通过（1000 并发连接）

---

### 2.2 Week 2: 领域模型与仓储

**TASK-003: 领域模型实现**
- **优先级**: P0
- **工时**: 3 天
- **负责人**: 后端工程师
- **描述**: 实现 Task/Crawl/WebhookEvent 领域模型及状态机
- **依赖**: TASK-002
- **核心代码示意**:
  ```rust
  // domain/models/task.rs
  impl Task {
      pub fn start(mut self) -> Result<Self, DomainError> {
          match self.status {
              TaskStatus::Queued => {
                  self.status = TaskStatus::Active;
                  Ok(self)
              }
              _ => Err(DomainError::InvalidStateTransition),
          }
      }
  }
  ```
- **验收标准**:
  - [ ] 所有状态转换有单元测试
  - [ ] 非法转换正确抛出错误
  - [ ] 领域事件正确触发

**TASK-004: 仓储接口与实现**
- **优先级**: P0
- **工时**: 4 天
- **负责人**: 后端工程师
- **描述**: 实现 TaskRepository 和 CrawlRepository
- **依赖**: TASK-003
- **关键方法**:
  - `create()`
  - `find_by_id()`
  - `acquire_next()` - 分布式锁
  - `mark_completed()`
- **验收标准**:
  - [x] 所有 CRUD 操作有集成测试
  - [x] 并发场景下的锁机制正确
  - [x] 查询性能符合基准（P95 < 10ms）
### 2.3 Week 3: API 层与中间件

**TASK-005: Axum 路由配置**
- **优先级**: P0
- **工时**: 2 天
- **负责人**: 后端工程师
- **描述**: 配置 Axum 路由，实现健康检查和版本端点
- **依赖**: TASK-004
- **端点清单**:
  ```
  GET  /health
  GET  /v1/version
  POST /v1/search (new)
  POST /v1/scrape
  GET  /v1/scrape/:id (new)
  POST /v1/crawl
  GET  /v1/crawl/:id
  GET  /v1/crawl/:id/results (new)
  DELETE /v1/crawl/:id (new)
  POST /v1/extract (new)
  ```
- **验收标准**:
  - [ ] 所有端点返回正确的状态码
  - [ ] 统一错误响应格式
  - [ ] OpenAPI 文档自动生成

**TASK-006: 认证中间件**
- **优先级**: P1
- **工时**: 2 天
- **负责人**: 后端工程师
- **描述**: 实现 API Key 认证中间件
- **依赖**: TASK-005
- **功能要求**:
  - 解析 `Authorization: Bearer <key>`
  - 查询 API Key 关联的 Team
  - 注入 `TeamContext` 到请求
- **验收标准**:
  - [ ] 无效 Key 返回 401
  - [ ] 有效 Key 正确解析 Team ID
  - [ ] 性能开销 < 1ms

**TASK-007: 速率限制与并发中间件**
- **优先级**: P1
- **工时**: 3 天
- **负责人**: 后端工程师
- **描述**: 实现基于 `governor` 的速率限制器和基于 Redis 的 Team Semaphore
- **依赖**: TASK-006
- **功能要求**:
  - 按 API Key 限制 RPM (Layer 1)
  - 按 Team ID 限制并发数 (Layer 2)
  - 限流后返回 429 和 Retry-After 头
  - 信号量耗尽时进入 Backlog (或返回特定错误)
- **验收标准**:
  - [ ] 限流测试通过（101 个请求第 101 个被拒绝）
  - [ ] 团队并发限制生效（超过配额排队或拒绝）
  - [ ] 不同 Team 配额隔离
  - [ ] 压力测试下无性能瓶颈

---

## 3. Phase 2: 核心功能开发（Week 4-7）

### 3.1 Week 4-5: 抓取引擎

**TASK-008: 搜索与提取服务实现**
- **优先级**: P1
- **工时**: 3 天
- **负责人**: 后端工程师
- **描述**: 实现 Search 和 Extract 服务的业务逻辑与端点
- **依赖**: TASK-005
- **功能要求**:
  - `POST /v1/search`: 集成搜索 API，支持 `async_scraping` 回填
  - `POST /v1/extract`: 集成 LLM 提取逻辑，计算 Token 消耗
- **验收标准**:
  - [ ] 搜索结果结构正确
  - [ ] 异步抓取任务正确创建
  - [ ] 提取服务能正确解析 Schema
  - [ ] Token/Credits 计费逻辑正确

**TASK-009: Fetch 引擎实现**
- **优先级**: P0
- **工时**: 3 天
- **负责人**: 后端工程师
- **描述**: 实现基于 `reqwest` 的轻量级抓取引擎
- **依赖**: TASK-007
- **关键特性**:
  - 独立 Cookie Jar（每请求隔离）
  - 自定义 User-Agent
  - 超时控制
  - SSRF 防护
- **验收标准**:
  - [ ] 成功抓取 10 个测试站点
  - [ ] SSRF 防护测试通过
  - [ ] Cookie 隔离测试通过

**TASK-010: Playwright 引擎集成**
- **优先级**: P1
- **工时**: 4 天
- **负责人**: 后端工程师
- **描述**: 实现对外部 Playwright 微服务的 HTTP 客户端
- **依赖**: TASK-009
- **功能要求**:
  - 构造请求 JSON
  - 解析响应
  - 错误重试
- **验收标准**:
  - [ ] 成功渲染 SPA 页面
  - [ ] 截图功能正常
  - [ ] 超时和重试逻辑正确

**TASK-011: 引擎路由器**
- **优先级**: P0
- **工时**: 3 天
- **负责人**: 架构师
- **描述**: 实现智能引擎选择和降级策略
- **依赖**: TASK-009, TASK-010
- **核心逻辑**:
  ```rust
  // 按打分排序引擎
  let mut engines = self.engines.iter()
      .map(|e| (e.support_score(request), e))
      .collect::<Vec<_>>();
  engines.sort_by_key(|(score, _)| Reverse(*score));
  
  // 依次尝试
  for (_, engine) in engines {
      if !circuit_breaker.is_open(engine.name()) {
          if let Ok(resp) = engine.scrape(request).await {
              return Ok(resp);
          }
      }
  }
  ```
- **验收标准**:
  - [ ] 优先级路由正确
  - [ ] 断路器机制生效
  - [ ] 所有引擎失败时返回明确错误

---

### 3.2 Week 6: 队列与调度

**TASK-012: 任务队列实现**
- **优先级**: P0
- **工时**: 4 天
- **负责人**: 后端工程师
- **描述**: 基于 Postgres 实现优先级队列
- **依赖**: TASK-004
- **功能要求**:
  - `enqueue()` - 入队
  - `dequeue()` - 出队（悲观锁）
  - `backlog()` - 积压处理
- **关键 SQL**:
  ```sql
  SELECT * FROM tasks
  WHERE status = 'queued'
  ORDER BY priority DESC, created_at ASC
  LIMIT 1
  FOR UPDATE SKIP LOCKED;
  ```
- **验收标准**:
  - [ ] 并发出队无冲突
  - [ ] 优先级排序正确
  - [ ] 积压机制测试通过

**TASK-013: Worker 管理器**
- **优先级**: P0
- **工时**: 3 天
- **负责人**: 后端工程师
- **描述**: 实现 Worker 池和任务分发
- **依赖**: TASK-012
- **功能要求**:
  - 启动 N 个 Tokio 任务作为 Worker
  - 每个 Worker 循环获取并处理任务
  - 优雅关闭（SIGTERM 处理）
- **验收标准**:
  - [ ] 10 个 Worker 并发处理无冲突
  - [ ] 任务分配均衡
  - [ ] 优雅关闭测试通过

---

### 3.3 Week 7: 爬取与去重

**TASK-014: 爬取发现逻辑**
- **优先级**: P0
- **工时**: 5 天
- **负责人**: 后端工程师
- **描述**: 实现链接提取、过滤和递归入队
- **依赖**: TASK-013
- **功能要求**:
  - 解析 HTML 提取 `<a>` 标签
  - 应用 include/exclude 规则
  - 深度控制
  - 去重（Redis Set）
- **验收标准**:
  - [ ] 正确提取 100 个页面的所有链接
  - [ ] 去重率 > 95%
  - [ ] 深度控制正确

**TASK-015: Robots.txt 遵守**
- **优先级**: P1
- **工时**: 2 天
- **负责人**: 后端工程师
- **描述**: 实现 robots.txt 解析和缓存
- **依赖**: TASK-014
- **功能要求**:
  - 首次访问域名时下载 robots.txt
  - 缓存规则到 Redis（24h TTL）
  - 每次请求前检查准入
- **验收标准**:
  - [ ] Disallow 规则生效
  - [ ] Crawl-delay 正确执行
  - [ ] 缓存命中率 > 90%

---

## 4. Phase 3: 高级特性与优化（Week 8-10）

### 4.1 Week 8: Webhook 与事件

**TASK-016: Webhook Outbox 实现**
- **优先级**: P1
- **工时**: 3 天
- **负责人**: 后端工程师
- **描述**: 实现事件持久化和投递队列
- **依赖**: TASK-015
- **功能要求**:
  - 事件写入 `webhook_events` 表
  - Worker 定期轮询并投递
  - 指数退避重试
  - HMAC 签名
- **验收标准**:
  - [ ] 事件成功投递率 > 99%
  - [ ] 重试逻辑正确
  - [ ] 签名校验通过

**TASK-017: 断路器实现**
- **优先级**: P1
- **工时**: 2 天
- **负责人**: 后端工程师
- **描述**: 实现引擎级断路器
- **依赖**: TASK-011
- **状态机**:
  ```
  Closed → Open (失败次数 > 阈值)
  Open → HalfOpen (超时后)
  HalfOpen → Closed (成功) | Open (失败)
  ```
- **验收标准**:
  - [ ] 连续 5 次失败后开启断路器
  - [ ] 30 秒后进入半开状态
  - [ ] 状态转换正确

---

### 4.2 Week 9: 监控与追踪

**TASK-018: 结构化日志**
- **优先级**: P1
- **工时**: 2 天
- **负责人**: DevOps
- **描述**: 配置 `tracing-subscriber`，输出 JSON 日志
- **依赖**: 无
- **功能要求**:
  - 按环境切换日志级别
  - 包含 trace_id 和 span_id
  - 输出到 stdout（容器化环境）
- **验收标准**:
  - [ ] 日志格式符合 JSON Schema
  - [ ] 可通过 trace_id 追踪请求全链路
  - [ ] 性能开销 < 5%

**TASK-019: Prometheus 指标**
- **优先级**: P2
- **工时**: 3 天
- **负责人**: DevOps
- **描述**: 暴露 `/metrics` 端点
- **依赖**: TASK-018
- **指标清单**:
  - `crawlrs_tasks_created_total`
  - `crawlrs_tasks_completed_total`
  - `crawlrs_scrape_duration_seconds`
  - `crawlrs_queue_depth`
- **验收标准**:
  - [ ] Prometheus 可正常抓取
  - [ ] Grafana 仪表盘配置完成
  - [ ] 告警规则配置

---

### 4.3 Week 10: 性能优化

**TASK-020: 数据库查询优化**
- **优先级**: P1
- **工时**: 3 天
- **负责人**: 后端工程师
- **描述**: 分析慢查询，优化索引
- **依赖**: TASK-012
- **优化清单**:
  - [ ] `acquire_next()` 查询 < 5ms
  - [ ] 批量插入使用 `INSERT ... VALUES (...), (...)`
  - [ ] 去除 N+1 查询
- **验收标准**:
  - [ ] 慢查询日志为空（> 50ms）
  - [ ] EXPLAIN ANALYZE 显示使用索引
  - [ ] 压力测试下无性能回归

**TASK-021: 连接池调优**
- **优先级**: P2
- **工时**: 2 天
- **负责人**: DevOps
- **描述**: 优化 Postgres/Redis 连接池配置
- **依赖**: TASK-020
- **调优参数**:
  - `max_connections`: 100
  - `min_connections`: 10
  - `idle_timeout`: 300s
  - `acquire_timeout`: 10s
- **验收标准**:
  - [ ] 连接泄漏检测通过
  - [ ] 连接复用率 > 95%
  - [ ] 高并发下无连接耗尽

---

## 5. Phase 4: 测试与上线准备（Week 11-12）

### 5.1 Week 11: 全面测试

**TASK-022: 集成测试补全**
- **优先级**: P0
- **工时**: 4 天
- **负责人**: QA
- **描述**: 补全所有核心流程的集成测试
- **依赖**: 所有功能完成
- **测试清单**:
  - [ ] 创建抓取任务
  - [ ] 创建爬取任务
  - [ ] 查询任务状态
  - [ ] 取消任务
  - [ ] Webhook 回调
- **验收标准**:
  - [ ] 覆盖率 ≥ 80%
  - [ ] 所有测试通过

**TASK-023: 压力测试**
- **优先级**: P0
- **工时**: 3 天
- **负责人**: QA
- **描述**: 执行 K6 压力测试
- **依赖**: TASK-022
- **测试场景**:
  - 1000 VU 持续 10 分钟
  - 100,000 任务积压测试
- **验收标准**:
  - [ ] P99 延迟 < 200ms
  - [ ] 失败率 < 0.1%
  - [ ] 无内存泄漏

---

### 5.2 Week 12: 部署与文档

**TASK-024: 部署脚本**
- **优先级**: P0
- **工时**: 2 天
- **负责人**: DevOps
- **描述**: 编写 Kubernetes 部署配置
- **依赖**: TASK-023
- **交付物**:
  - Helm Chart
  - HPA 配置
  - Ingress 配置
- **验收标准**:
  - [ ] 一键部署成功
  - [ ] 滚动更新无中断
  - [ ] HPA 自动扩缩容正常

**TASK-025: 运维手册**
- **优先级**: P1
- **工时**: 2 天
- **负责人**: DevOps
- **描述**: 编写运维文档
- **依赖**: TASK-024
- **文档内容**:
  - 部署流程
  - 故障排查
  - 告警处理
  - 回滚流程
- **验收标准**:
  - [ ] 文档完整清晰
  - [ ] 模拟演练通过

**TASK-026: API 文档**
- **优先级**: P1
- **工时**: 2 天
- **负责人**: 后端工程师
- **描述**: 生成 OpenAPI 3.0 文档
- **依赖**: TASK-005
- **交付物**:
  - Swagger UI
  - Postman Collection
- **验收标准**:
  - [ ] 所有端点有示例
  - [ ] 响应结构完整
  - [ ] 错误码文档化

---

## 6. 风险管理

### 6.1 技术风险

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|---------|
| Rust 学习曲线陡峭 | 中 | 高 | 提前技术培训，结对编程 |
| SeaORM 性能问题 | 低 | 中 | 建立性能基准，必要时降级到 sqlx |
| 引擎集成失败 | 中 | 高 | 提前验证 PoC，预留降级方案 |
| 数据库迁移失败 | 低 | 高 | 充分测试，准备回滚脚本 |

### 6.2 进度风险

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|---------|
| 人员不足 | 中 | 高 | 提前招聘，必要时外包 |
| 需求变更 | 高 | 中 | 冻结需求，设置变更窗口 |
| 测试时间不足 | 中 | 高 | 提前介入测试，并行开发与测试 |

---

## 7. 资源分配

### 7.1 团队配置

| 角色 | 人数 | 职责 |
|------|------|------|
| 架构师 | 1 | 架构设计，技术选型，Code Review |
| 后端工程师 | 3 | 核心功能开发 |
| DevOps 工程师 | 1 | CI/CD，部署，监控 |
| QA 工程师 | 1 | 测试用例，自动化测试 |
| 产品经理 | 1 | 需求管理，验收 |

### 7.2 工时预估

| Phase | 人天 | 关键路径 |
|-------|------|----------|
| Phase 1 | 45 | 数据库设计 → 仓储实现 → API 层 |
| Phase 2 | 60 | 抓取引擎 → 队列系统 → 爬取逻辑 |
| Phase 3 | 30 | Webhook → 监控 → 优化 |
| Phase 4 | 25 | 测试 → 部署 → 文档 |
| **总计** | **160** | **约 12 周** |

---

## 8. 验收标准

### 8.1 功能验收
- [ ] 所有 API 端点正常工作
- [ ] 单机模式部署成功
- [ ] 集群模式部署成功
- [ ] 监控告警正常

### 8.2 性能验收
- [ ] API 吞吐量 > 10000 RPS (PRD 目标)
- [ ] P99 延迟 < 200ms
- [ ] Worker 处理速度 > 1000 tasks/min
- [ ] 成功率 > 99.9%

### 8.3 质量验收
- [ ] 测试覆盖率 ≥ 80%
- [ ] 无 P0/P1 Bug
- [ ] 文档完整

---

## 变更记录

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|---------|------|
| v2.0.0 | 2024-12-10 | 初始任务规划 | 项目经理 |